---
title: "Getting started 1 - Installing and running BRMS"
output: html_document
date: "2023-05-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

`bayesnec` is a toxicity estimate and No-Effect-Concentration estimation package that uses
[`brms`](https://github.com/paul-buerkner/brms) to fit concentration(dose)-response data using Bayesian methods. In order to use `bayesnec` it is first necessary to make sure you have `brms` working on your machine. 

The `brms` package provides an interface to fit Bayesian generalized
(non-)linear multivariate multilevel models using Stan, which is a C++ package
for performing full Bayesian inference (see https://mc-stan.org/). The formula
syntax is very similar to that of the package `lme4` to provide a familiar and
simple interface for performing regression analyses. A wide range of response
distributions are supported, allowing users to fit -- among others -- linear,
robust linear, count data, survival, response times, ordinal, zero-inflated, and
even self-defined mixture models all in a multilevel context. Further modeling
options include non-linear and smooth terms, auto-correlation structures,
censored data, missing value imputation, and quite a few more. In addition, all
parameters of the response distribution can be predicted in order to perform
distributional regression. Multivariate models (i.e., models with multiple
response variables) can be fit, as well. Prior specifications are flexible and
explicitly encourage users to apply prior distributions that actually reflect
their beliefs. Model fit can easily be assessed and compared with posterior
predictive checks, cross-validation, and Bayes factors.


`brms` can use two alternative interfaces to Stan, including `rstan` and `cmdstanr` both of which require Rtools and the g++ compiler to be properly configured in R. Making sure `brms` is properly working on your machine is essential before any attempt to use the `bayesnec` package for analyses. 

## rstan

The default `brms` interface between Stan and R is the package [`rstan`](https://cran.r-project.org/web/packages/rstan/index.html). We can follow the instructions on the [`rstan` github](https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started) to ensure this is working on your machine. We follow these instructions here.


### Configuring C++ Toolchain

Prior to installing RStan, you need to configure your R installation to be able to compile C++ code.

### Installing RStan

To be on the safe side, it is sometimes necessary to remove any existing RStan via

```{r remove, eval=FALSE}
remove.packages("rstan")
if (file.exists(".RData")) file.remove(".RData")
```

Then, restart R.

If you are using R version 3.x on a Mac, go to [here](https://github.com/stan-dev/rstan/wiki/Installing-RStan-from-Source#mac). 
If you are using R 4.3 and RTools43 (which we recommend), then install rtsan using the following code:

```{r install, eval=FALSE}
install.packages("StanHeaders", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```

Follow the link below for your respective operating system and configuration for more instructions:

[Windows - Configuring C++ Toolchain](https://github.com/stan-dev/rstan/wiki/Configuring-C---Toolchain-for-Windows)

[Mac - Configuring C++ Toolchain](https://github.com/stan-dev/rstan/wiki/Configuring-C---Toolchain-for-Mac)

[Linux - Configuring C++ Toolchain](https://github.com/stan-dev/rstan/wiki/Configuring-C-Toolchain-for-Linux)


### Verifying the rstan Installation

To verify your installation, you can run the RStan example/test model:

```{r example}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
x=rnorm(1000,5,1)
my_data=list(N=1000,x=x)
stancode = 'data{ int N; real x[N];} parameters{real mu;real sigma;} 
model{ x ~ normal(mu,sigma);}'
fit = stan(model_code = stancode,data=my_data)

```

The model should then compile and sample.
We can see a summary of the model parameters using:

```{r summary}
summary(fit)
```


## BRMS




